### Intermediate mapping
First, we performed Intermediate mapping. Specifically, for each of all 1022 genes in the STARmap PLUS, we performed an intermediate mapping to align each STARmap PLUS cell with the most similar set of cells in the scRNA-seq dataset. The dimension reduction and batch effect correction methods were UMAP and Harmony, same as the analysis before. Here, the leave-one-gene-out mapping approach was used to assess the performance changes caused by the number of nearest neighbors in scRNA-seq data. According to the result in Extended Data Figure S7a, we chose the number of nearest neighbors to be 200.
`intermediate_mapping.py`

### Final imputation
Finally, we performed a final imputation. We first checked the quality of the scRNA-seq data1: genes with average read < 0.005 / sum read < 740 across 146,201 cells (50th percentile of the data) were filtered; genes with maximum read <= 10 were filtered. We found that 11,844 genes were left after the filtration and then used these genes for imputation. To perform imputation for all genes, we aggregated across the intermediate mappings generated from each gene probed using STARmap PLUS. Specifically, for each STARmap PLUS cell, we considered the set of all scRNA-seq atlas cells that were associated with it in any intermediate mapping. Subsequently, for every cell, we calculated each gene’s imputed expression level as the weighted average of the gene’s expression across the associated set of scRNA-seq atlas cells, where weights were proportional to the number of times each scRNA-seq atlas cell was present. Thus, the imputed expression profiles for all genes, including those in the overlapping gene set, are on the same scale as the scRNA-seq log count data. The output is a 1,091,527 cell by 11,844 genes matrix. We also evaluated the performance score for the imputed genes by comparing them to Allen ISH data27. The performance score was calculated as the Pearson correlation (across cells) between its imputed values and its measured STARmap PLUS expression level. Representative results were shown in Figure 3c.
`final_imputation_compute.py`
